---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/BaseLayout.astro';

type ServiceEntry = Awaited<ReturnType<typeof getCollection>>[number];

const all = await getCollection('services');

// agrupar por categoría y ordenar por "order" y "title"
const byCategory = all.reduce<Record<string, ServiceEntry[]>>((acc, entry) => {
  const cat = entry.data.category || 'Otros';
  acc[cat] ||= [];
  acc[cat].push(entry);
  return acc;
}, {});

Object.keys(byCategory).forEach((cat) => {
  byCategory[cat].sort((a, b) => {
    const ao = a.data.order ?? 9999;
    const bo = b.data.order ?? 9999;
    if (ao !== bo) return ao - bo;
    return a.data.title.localeCompare(b.data.title);
  });
});

const categories = Object.keys(byCategory).sort();
---

<Layout title="Servicios" description="Listado completo de servicios por categoría">
  <section class="max-w-7xl mx-auto px-4 py-12">
    <h1 class="text-3xl md:text-4xl font-bold">Servicios</h1>
    <p class="text-slate-600 mt-2">Explora nuestros servicios por categoría.</p>

    <div class="mt-8 space-y-10">
      {categories.map((cat) => (
        <section>
          <h2 class="text-2xl font-semibold">{cat}</h2>
          <ul class="mt-4 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {byCategory[cat].map((entry) => (
              <li class="border rounded-xl p-5 hover:shadow transition">
                <a href={`/services/${entry.slug}`} class="block">
                  {entry.data.img && (
                    <img
                      src={`/${entry.data.img}`}
                      alt={entry.data.title}
                      class="h-40 w-full object-cover rounded-lg mb-3"
                      loading="lazy"
                    />
                  )}
                  <h3 class="text-lg font-semibold">{entry.data.title}</h3>
                  {entry.data.description && (
                    <p class="text-sm text-slate-600 mt-1 line-clamp-2">
                      {entry.data.description}
                    </p>
                  )}
                </a>
              </li>
            ))}
          </ul>
        </section>
      ))}
    </div>
  </section>
</Layout>

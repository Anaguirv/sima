---
import Site from "@/layouts/Site.astro";
import { getCollection } from "astro:content";
import CATS from "@/data/services-categories.json";

const entries = (await getCollection("services"))
  .sort((a, b) => (a.data.order ?? 999) - (b.data.order ?? 999));

const CATEGORIES = ["Todas", ...CATS.categories.map((c) => c.name)];
---

<Site title="Servicios ‚Äì SIMA Ingenier√≠a" description="Soluciones de Ingenier√≠a, Medio Ambiente y Operaci√≥n.">
  <!-- Hero -->
  <section class="relative">
    <div class="bg-gradient-to-b from-[rgba(8,62,82,.95)] to-[rgba(11,122,163,.9)]">
      <div class="mx-auto max-w-7xl px-4 py-12 text-white">
        <h1 class="text-3xl md:text-4xl font-bold">Servicios</h1>
        <p class="mt-2 max-w-3xl text-white/90">
          Filtra por categor√≠a para explorar las soluciones de SIMA Ingenier√≠a.
        </p>
      </div>
    </div>
  </section>

  <!-- Filtros -->
  <section class="mx-auto max-w-7xl px-4 pt-6">
    <!-- Select m√≥vil -->
    <div class="sm:hidden">
      <label for="svc-filter" class="sr-only">Filtrar por categor√≠a</label>
      <select id="svc-filter" class="w-full rounded-xl border border-[rgba(11,122,163,.25)] bg-white px-3 py-2 text-sm text-[rgb(8,62,82)]">
        {CATEGORIES.map((c) => <option value={c}>{c}</option>)}
      </select>
    </div>

    <!-- Chips desktop -->
    <div class="hidden sm:flex flex-wrap gap-2">
      {CATEGORIES.map((c, i) => (
        <button
          class={`svc-chip rounded-full border px-3 py-1.5 text-sm font-medium transition
                  ${i === 0
                    ? "bg-[rgba(11,122,163,.08)] border-[rgba(11,122,163,.25)] text-[rgb(8,62,82)]"
                    : "border-slate-200 text-slate-700 hover:bg-slate-50"}`}
          data-cat={c}
          aria-pressed={i === 0 ? "true" : "false"}
        >
          {c}
        </button>
      ))}
    </div>
  </section>

  <!-- Grid de servicios -->
  <section class="mx-auto max-w-7xl px-4 py-12">
    <div id="svc-grid" class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3 transition-all">
      {entries.map(({ slug, data }) => {
        const cat = data.category ?? "Sin categor√≠a";
        return (
          <a
            href={`/services/${slug}/`}
            class="svc-card group relative rounded-2xl overflow-hidden border border-[rgba(11,122,163,0.15)] bg-white shadow-sm hover:shadow-xl transition-all duration-500 hover:-translate-y-1 opacity-100 translate-y-0"
            data-cat={cat}
            style="transition: opacity 0.4s ease, transform 0.4s ease;"
          >
            <!-- Imagen -->
            <figure class="relative aspect-[4/3] w-full overflow-hidden bg-slate-100">
              <img
                src={data.img ?? '/images/placeholder.webp'}
                alt={data.title}
                class="h-full w-full object-cover transition-transform duration-[1500ms] ease-[cubic-bezier(.19,1,.22,1)] group-hover:scale-110"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-[rgba(8,62,82,0.55)] via-[rgba(8,62,82,0.1)] to-transparent opacity-60 group-hover:opacity-80 transition"></div>
              <span
                class="absolute bottom-3 left-4 text-xs font-semibold tracking-wide text-white bg-[rgba(11,122,163,0.8)] px-3 py-1.5 rounded-full backdrop-blur-sm border border-[rgba(255,255,255,0.2)] shadow"
              >
                {cat}
              </span>
            </figure>

            <!-- Cuerpo -->
            <div class="p-5 flex flex-col justify-between h-full">
              <div>
                <h3 class="text-lg font-bold text-[rgb(8,62,82)] group-hover:text-[rgb(11,122,163)] transition-colors">
                  {data.title}
                </h3>
                {data.description && (
                  <p class="mt-2 text-sm text-slate-600 line-clamp-3 leading-relaxed">
                    {data.description}
                  </p>
                )}
              </div>

              <!-- Footer -->
              <div class="mt-4 flex items-center justify-between">
                <span class="inline-flex items-center gap-1 text-[rgb(11,122,163)] text-sm font-semibold group-hover:gap-2 transition-all">
                  Ver servicio
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    class="transition-transform duration-300 group-hover:translate-x-1"
                  >
                    <path
                      fill="currentColor"
                      d="M13 5l7 7l-7 7v-4H4v-6h9z"
                    />
                  </svg>
                </span>
              </div>
            </div>

            <!-- Borde din√°mico -->
            <div
              class="absolute inset-0 rounded-2xl border-2 border-transparent group-hover:border-[rgba(11,122,163,0.3)] transition-all duration-500 pointer-events-none"
            ></div>
          </a>
        );
      })}
    </div>
  </section>

  <!-- Script: filtro categor√≠a (funcional intacto) -->
  <script is:inline>
    const chips = document.querySelectorAll('.svc-chip');
    const select = document.getElementById('svc-filter');
    const cards = document.querySelectorAll('.svc-card');
    const grid = document.getElementById('svc-grid');

    // üîç Aplica filtro a las cards seg√∫n la categor√≠a
    function applyFilter(cat) {
      const target = (cat || 'Todas').trim().toLowerCase();
      cards.forEach(card => {
        const c = (card.getAttribute('data-cat') || '').trim().toLowerCase();
        const visible = (target === 'todas' || c === target);
        card.style.display = visible ? '' : 'none';
        card.style.opacity = visible ? '1' : '0';
        card.style.transform = visible ? 'translateY(0)' : 'translateY(10px)';
      });
    }

    // üé® Marca visualmente la categor√≠a activa
    function setActive(cat) {
      const target = (cat || 'Todas').trim();
      chips.forEach(btn => {
        const match = btn.getAttribute('data-cat') === target;
        btn.setAttribute('aria-pressed', match ? 'true' : 'false');
        btn.classList.toggle('bg-[rgba(11,122,163,.08)]', match);
        btn.classList.toggle('border-[rgba(11,122,163,.25)]', match);
        btn.classList.toggle('text-[rgb(8,62,82)]', match);
      });
      if (select) select.value = target;
    }

    // üß≠ Guarda y lee filtro actual desde la URL
    function updateURL(cat) {
      history.replaceState(null, '', `?cat=${encodeURIComponent(cat)}`);
    }

    // üíæ Guarda preferencia del usuario en localStorage
    function saveFilter(cat) {
      localStorage.setItem('svc-last-cat', cat);
    }
    function loadFilter() {
      return localStorage.getItem('svc-last-cat') || 'Todas';
    }

    // üñ±Ô∏è Eventos: clics en chips (desktop)
    chips.forEach(btn => {
      btn.addEventListener('click', () => {
        const cat = btn.getAttribute('data-cat');
        setActive(cat);
        applyFilter(cat);
        updateURL(cat);
        saveFilter(cat);
      });
    });

    // üì± Eventos: cambio en el select (m√≥vil)
    if (select) {
      select.addEventListener('change', (e) => {
        const cat = e.target.value;
        setActive(cat);
        applyFilter(cat);
        updateURL(cat);
        saveFilter(cat);
      });
    }

    // üöÄ Al cargar: decide qu√© filtro usar
    const params = new URLSearchParams(location.search);
    const urlCat = params.get('cat');
    const storedCat = loadFilter();
    const startCat = urlCat || storedCat || 'Todas';

    setActive(startCat);
    applyFilter(startCat);

    grid.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
  </script>
</Site>
